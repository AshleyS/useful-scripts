#!/bin/bash

if [ ! "$#" -eq 1 ]; then
	echo "Usage: $0 <directory>"
	exit
fi

DIRECTORY=$1

if [[ ! -d $DIRECTORY ]]; then
	echo "ERROR: $DIRECTORY is not a directory"
	exit
fi

TIMESTAMP=$(date +"%s")

MIGRATION_DIRECTORY="$DIRECTORY/$TIMESTAMP"
HEADER_SQL="# Auto-generated by dbmigration\n\n# Your SQL here\n"
UPDATE_STATEMENT="$HEADER_SQL\nINSERT INTO database_version ( version ) VALUES ( '$TIMESTAMP' );"
ROLLBACK_STATEMENT="$HEADER_SQL\nDELETE FROM database_version WHERE version = '$TIMESTAMP';"

mkdir -p "$MIGRATION_DIRECTORY"
printf "$UPDATE_STATEMENT" > "$MIGRATION_DIRECTORY/update.sql"
printf "$ROLLBACK_STATEMENT" > "$MIGRATION_DIRECTORY/rollback.sql"

echo "Done."
